Index: squashfs-tools-4.2+20130409/Makefile
===================================================================
--- squashfs-tools-4.2+20130409.orig/Makefile	2021-08-31 15:29:05.256808878 +0200
+++ squashfs-tools-4.2+20130409/Makefile	2021-08-31 15:30:46.268862646 +0200
@@ -101,7 +101,7 @@
 	caches-queues-lists.o
 
 UNSQUASHFS_OBJS = unsquashfs.o unsquash-1.o unsquash-2.o unsquash-3.o \
-	unsquash-4.o swap.o compressor.o
+	unsquash-4.o unsquash-1234.o swap.o compressor.o
 
 CFLAGS ?= -O2
 CFLAGS += $(EXTRA_CFLAGS) $(INCLUDEDIR) -D_FILE_OFFSET_BITS=64 \
@@ -258,6 +258,8 @@
 unsquash-4.o: unsquashfs.h unsquash-4.c squashfs_fs.h squashfs_swap.h \
 	read_fs.h
 
+unsquash-1234.o: unsquash-1234.c
+
 unsquashfs_xattr.o: unsquashfs_xattr.c unsquashfs.h squashfs_fs.h xattr.h
 
 
Index: squashfs-tools-4.2+20130409/unsquash-1.c
===================================================================
--- squashfs-tools-4.2+20130409.orig/unsquash-1.c	2021-08-31 15:29:05.256808878 +0200
+++ squashfs-tools-4.2+20130409/unsquash-1.c	2021-08-31 15:29:05.256808878 +0200
@@ -285,6 +285,13 @@
 			memcpy(dire->name, directory_table + bytes,
 				dire->size + 1);
 			dire->name[dire->size + 1] = '\0';
+
+			/* check name for invalid characters (i.e /, ., ..) */
+			if(check_name(dire->name, dire->size + 1) == FALSE) {
+				ERROR("File system corrupted: invalid characters in name\n");
+				goto corrupted;
+			}
+
 			TRACE("squashfs_opendir: directory entry %s, inode "
 				"%d:%d, type %d\n", dire->name,
 				dirh.start_block, dire->offset, dire->type);
Index: squashfs-tools-4.2+20130409/unsquash-1234.c
===================================================================
--- /dev/null	1970-01-01 00:00:00.000000000 +0000
+++ squashfs-tools-4.2+20130409/unsquash-1234.c	2021-08-31 15:29:05.256808878 +0200
@@ -0,0 +1,58 @@
+/*
+ * Unsquash a squashfs filesystem.  This is a highly compressed read only
+ * filesystem.
+ *
+ * Copyright (c) 2021
+ * Phillip Lougher <phillip@squashfs.org.uk>
+ *
+ * This program is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU General Public License
+ * as published by the Free Software Foundation; either version 2,
+ * or (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License
+ * along with this program; if not, write to the Free Software
+ * Foundation, 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+ *
+ * unsquash-1234.c
+ *
+ * Helper functions used by unsquash-1, unsquash-2, unsquash-3 and
+ * unsquash-4.
+ */
+
+#define TRUE 1
+#define FALSE 0
+/*
+ * Check name for validity, name should not
+ *  - be ".", "./", or
+ *  - be "..", "../" or
+ *  - have a "/" anywhere in the name, or
+ *  - be shorter than the expected size
+ */
+int check_name(char *name, int size)
+{
+	char *start = name;
+
+	if(name[0] == '.') {
+		if(name[1] == '.')
+			name++;
+		if(name[1] == '/' || name[1] == '\0')
+			return FALSE;
+	}
+
+	while(name[0] != '/' && name[0] != '\0')
+		name ++;
+
+	if(name[0] == '/')
+		return FALSE;
+
+	if((name - start) != size)
+		return FALSE;
+
+	return TRUE;
+}
Index: squashfs-tools-4.2+20130409/unsquash-3.c
===================================================================
--- squashfs-tools-4.2+20130409.orig/unsquash-3.c	2021-08-31 15:29:05.256808878 +0200
+++ squashfs-tools-4.2+20130409/unsquash-3.c	2021-08-31 15:29:05.256808878 +0200
@@ -363,6 +363,13 @@
 			memcpy(dire->name, directory_table + bytes,
 				dire->size + 1);
 			dire->name[dire->size + 1] = '\0';
+
+			/* check name for invalid characters (i.e /, ., ..) */
+			if(check_name(dire->name, dire->size + 1) == FALSE) {
+				ERROR("File system corrupted: invalid characters in name\n");
+				goto corrupted;
+			}
+
 			TRACE("squashfs_opendir: directory entry %s, inode "
 				"%d:%d, type %d\n", dire->name,
 				dirh.start_block, dire->offset, dire->type);
Index: squashfs-tools-4.2+20130409/unsquash-4.c
===================================================================
--- squashfs-tools-4.2+20130409.orig/unsquash-4.c	2021-08-31 15:29:05.256808878 +0200
+++ squashfs-tools-4.2+20130409/unsquash-4.c	2021-08-31 15:29:05.256808878 +0200
@@ -322,6 +322,13 @@
 			memcpy(dire->name, directory_table + bytes,
 				dire->size + 1);
 			dire->name[dire->size + 1] = '\0';
+
+			/* check name for invalid characters (i.e /, ., ..) */
+			if(check_name(dire->name, dire->size + 1) == FALSE) {
+				ERROR("File system corrupted: invalid characters in name\n");
+				goto corrupted;
+			}
+
 			TRACE("squashfs_opendir: directory entry %s, inode "
 				"%d:%d, type %d\n", dire->name,
 				dirh.start_block, dire->offset, dire->type);
Index: squashfs-tools-4.2+20130409/unsquashfs.h
===================================================================
--- squashfs-tools-4.2+20130409.orig/unsquashfs.h	2021-08-31 15:29:05.256808878 +0200
+++ squashfs-tools-4.2+20130409/unsquashfs.h	2021-08-31 15:31:22.632881610 +0200
@@ -266,3 +266,6 @@
 extern struct dir *squashfs_opendir_4(unsigned int, unsigned int,
 	struct inode **);
 extern int read_uids_guids_4();
+
+/* unsquash-1234.c */
+extern int check_name(char *, int);
